name: Build, Push, and Deploy via ArgoCD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'main-latest'
      skip_build:
        description: 'Skip build and deploy existing image'
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.final-tag.outputs.image_tag }}
      should-deploy: ${{ steps.should-deploy.outputs.deploy }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Determine if deployment should occur
      id: should-deploy
      run: |
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "deploy=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "deploy=true" >> $GITHUB_OUTPUT
        else
          echo "deploy=false" >> $GITHUB_OUTPUT
        fi

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate final image tag for deployment
      id: final-tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        else
          BRANCH=${GITHUB_REF#refs/heads/}
          SHORT_SHA=${GITHUB_SHA:0:7}
          IMAGE_TAG="${BRANCH}-${SHORT_SHA}"
        fi
        echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "Deployment image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

    - name: Run security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.final-tag.outputs.image_tag }}
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  deploy-argocd:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: ${{ always() && (needs.build-and-push.outputs.should-deploy == 'true' || inputs.skip_build) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Determine image tag for deployment
      id: deploy-tag
      run: |
        if [ "${{ inputs.skip_build }}" = "true" ]; then
          IMAGE_TAG="${{ inputs.image_tag }}"
        else
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
        fi
        echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "Deploying image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

    - name: Get ArgoCD Token
      id: argocd-auth
      run: |
        # Fetch ArgoCD token using admin credentials
        ARGOCD_TOKEN=$(curl -k -X POST ${{ secrets.ARGOCD_SERVER }}/api/v1/session \
          -d '{"username":"admin","password":"${{ secrets.ARGOCD_PASSWORD }}"}' \
          -H "Content-Type: application/json" | jq -r .token)
        
        if [ "$ARGOCD_TOKEN" = "null" ] || [ -z "$ARGOCD_TOKEN" ]; then
          echo "❌ Failed to get ArgoCD token"
          exit 1
        fi
        
        echo "✅ Successfully obtained ArgoCD token"
        echo "argocd_token=${ARGOCD_TOKEN}" >> $GITHUB_OUTPUT

    - name: Update ArgoCD Application Image
      run: |
        # Update the application spec with new image
        curl -k -X PATCH \
          "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/nodejs-app" \
          -H "Authorization: Bearer ${{ steps.argocd-auth.outputs.argocd_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "spec": {
              "source": {
                "kustomize": {
                  "images": ["${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.deploy-tag.outputs.image_tag }}"]
                }
              }
            }
          }'

    - name: Trigger ArgoCD Sync
      run: |
        # Trigger deployment sync
        SYNC_RESPONSE=$(curl -k -X POST \
          "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/nodejs-app/sync" \
          -H "Authorization: Bearer ${{ steps.argocd-auth.outputs.argocd_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "revision": "main",
            "prune": true,
            "dryRun": false
          }')
        
        echo "Sync triggered: $SYNC_RESPONSE"
        
        # Extract operation name for tracking
        OPERATION_NAME=$(echo $SYNC_RESPONSE | jq -r '.metadata.name // "unknown"')
        echo "operation_name=${OPERATION_NAME}" >> $GITHUB_ENV

    - name: Wait for deployment completion
      run: |
        echo "Waiting for deployment to complete..."
        
        # Poll deployment status
        for i in {1..60}; do  # Wait up to 10 minutes
          STATUS_RESPONSE=$(curl -k -s \
            "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/nodejs-app" \
            -H "Authorization: Bearer ${{ steps.argocd-auth.outputs.argocd_token }}")
          
          SYNC_STATUS=$(echo $STATUS_RESPONSE | jq -r '.status.sync.status')
          HEALTH_STATUS=$(echo $STATUS_RESPONSE | jq -r '.status.health.status')
          OPERATION_PHASE=$(echo $STATUS_RESPONSE | jq -r '.status.operationState.phase // "Unknown"')
          
          echo "Sync: $SYNC_STATUS, Health: $HEALTH_STATUS, Operation: $OPERATION_PHASE"
          
          if [ "$OPERATION_PHASE" = "Succeeded" ] && [ "$HEALTH_STATUS" = "Healthy" ]; then
            echo "✅ Deployment completed successfully!"
            break
          elif [ "$OPERATION_PHASE" = "Failed" ] || [ "$OPERATION_PHASE" = "Error" ]; then
            echo "❌ Deployment failed!"
            exit 1
          fi
          
          sleep 10
        done
        
        # Final status check
        if [ "$OPERATION_PHASE" != "Succeeded" ]; then
          echo "❌ Deployment timed out or failed"
          exit 1
        fi

    - name: Get deployment details
      run: |
        # Get current application status
        curl -k -s \
          "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/nodejs-app" \
          -H "Authorization: Bearer ${{ steps.argocd-auth.outputs.argocd_token }}" | \
          jq '{
            name: .metadata.name,
            image: .spec.source.kustomize.images[0],
            sync_status: .status.sync.status,
            health_status: .status.health.status,
            last_sync: .status.operationState.finishedAt,
            revision: .status.sync.revision
          }'

    - name: Create deployment summary
      run: |
        echo "## 🚀 ArgoCD Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.deploy-tag.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ✅ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "**ArgoCD App:** \`nodejs-app\`" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View in ArgoCD: [${{ secrets.ARGOCD_SERVER }}/applications/nodejs-app](${{ secrets.ARGOCD_SERVER }}/applications/nodejs-app)" >> $GITHUB_STEP_SUMMARY

  rollback:
    runs-on: ubuntu-latest
    if: ${{ failure() && needs.deploy-argocd.result == 'failure' }}
    needs: [build-and-push, deploy-argocd]
    
    steps:
    - name: Get ArgoCD Token for Rollback
      id: argocd-auth-rollback
      run: |
        # Fetch ArgoCD token using admin credentials
        ARGOCD_TOKEN=$(curl -k -X POST ${{ secrets.ARGOCD_SERVER }}/api/v1/session \
          -d '{"username":"admin","password":"${{ secrets.ARGOCD_PASSWORD }}"}' \
          -H "Content-Type: application/json" | jq -r .token)
        
        if [ "$ARGOCD_TOKEN" = "null" ] || [ -z "$ARGOCD_TOKEN" ]; then
          echo "❌ Failed to get ArgoCD token for rollback"
          exit 1
        fi
        
        echo "✅ Successfully obtained ArgoCD token for rollback"
        echo "argocd_token=${ARGOCD_TOKEN}" >> $GITHUB_OUTPUT
        
    - name: Rollback deployment
      run: |
        echo "🔄 Rolling back deployment..."
        
        # Get previous revision
        HISTORY_RESPONSE=$(curl -k -s \
          "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/nodejs-app/revisions" \
          -H "Authorization: Bearer ${{ steps.argocd-auth-rollback.outputs.argocd_token }}")
        
        PREVIOUS_REVISION=$(echo $HISTORY_RESPONSE | jq -r '.[1].id // "1"')
        
        # Trigger rollback
        curl -k -X POST \
          "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/nodejs-app/rollback" \
          -H "Authorization: Bearer ${{ steps.argocd-auth-rollback.outputs.argocd_token }}" \
          -H "Content-Type: application/json" \
          -d "{\"id\": \"$PREVIOUS_REVISION\"}"
        
        echo "Rollback to revision $PREVIOUS_REVISION initiated"

    - name: Create rollback summary
      run: |
        echo "## 🔄 Deployment Rollback" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Deployment failed - automatic rollback initiated" >> $GITHUB_STEP_SUMMARY
        echo "**ArgoCD App:** \`nodejs-app\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check ArgoCD for rollback status: [${{ secrets.ARGOCD_SERVER }}/applications/nodejs-app](${{ secrets.ARGOCD_SERVER }}/applications/nodejs-app)" >> $GITHUB_STEP_SUMMARY
